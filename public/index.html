<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seismic Risk AI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --bg: #1a1a1a; --panel: #2c2c2c; --text: #e0e0e0;
            --accent: #4a90e2; --danger: #ff4444; --success: #00c851;
            --user-event: #a333ff;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        #app { display: flex; height: 100%; }

        /* SIDEBAR */
        #sidebar { 
            width: 350px; background: var(--panel); display: flex; flex-direction: column; 
            border-right: 1px solid #444; z-index: 1000; transition: width 0.3s ease; overflow-x: hidden; white-space: nowrap;
        }
        #sidebar.collapsed { width: 60px; }
        #sidebar.collapsed .hide-on-collapse { display: none; opacity: 0; }
        #sidebar.collapsed .header { justify-content: center; }
        #sidebar.collapsed .menu-toggle { margin: 0; }

        .header { padding: 15px; background: #222; border-bottom: 1px solid #444; display: flex; align-items: center; }
        .menu-toggle { cursor: pointer; font-size: 1.4rem; margin-right: 15px; color: var(--accent); min-width: 24px; text-align: center; }
        
        .controls { padding: 15px; background: #333; border-bottom: 1px solid #444; }

        /* SLIDER STYLE */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0 15px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #111; border-radius: 4px; border: 1px solid #444; }
        input[type=range]::-webkit-slider-thumb { height: 18px; width: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.5); border: 2px solid #fff; }

        .btn { 
            width: 100%; padding: 10px; border: none; color: white; cursor: pointer; border-radius: 5px; 
            font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: none; }
        
        .btn-refresh { background: var(--accent); }
        .btn-add { background: var(--user-event); }
        .btn-risk { background: rgba(255, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .btn-risk:hover { background: var(--danger); color: white; }
        .btn-play { background: #444; border: 1px solid #666; }
        .btn-play.playing { background: var(--success); color: black; border-color: var(--success); }

        /* Delete Button Style */
        .btn-delete {
            background: transparent; border: 1px solid #555; color: #aaa; 
            padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-top: 5px;
        }
        .btn-delete:hover { background: var(--danger); color: white; border-color: var(--danger); }

        #list { flex: 1; overflow-y: auto; padding: 10px; }
        .quake-item { background: #3a3a3a; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; border-left: 5px solid transparent; position: relative; }
        .quake-item:hover { background: #444; }

        /* MAP & MARKERS */
        #map { flex: 1; background: #0b0b0b; }
        .user-pin { width: 16px; height: 16px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 0 2px white, 0 0 15px var(--accent); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2.5); } }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; }
        .modal { background: var(--panel); padding: 25px; border-radius: 8px; width: 320px; border: 1px solid #555; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .modal h3 { margin-top: 0; color: var(--user-event); margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; outline: none; }
        .form-group input:focus { border-color: var(--accent); }
        .label-danger { color: var(--danger); font-weight: bold; }
        .error-msg { color: var(--danger); font-size: 0.8rem; display: none; margin-top: 5px; }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div class="header">
            <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>
            <div class="hide-on-collapse" style="font-weight:bold;">Seismic Hub</div>
        </div>
        
        <div class="controls hide-on-collapse">
            <label style="font-size:0.8rem; color:#aaa; margin-bottom: 5px; display:block;">Min Mag: <b id="magVal" style="color:var(--accent)">2.5</b></label>
            <input type="range" id="magInput" min="0" max="8" step="0.1" value="2.5">

            <button class="btn btn-refresh" onclick="updateData()">üîÑ Refresh</button>
            <button class="btn btn-add" onclick="enableAddMode()">‚ûï Add Event</button>
            <button class="btn btn-risk" onclick="flyHighRisk()">‚ö†Ô∏è Highest Risk</button>
            <button id="btnPlay" class="btn btn-play" onclick="playHistory()">‚ñ∂ Play 24h History</button>
            
            <div id="addHint" style="display:none; color:var(--user-event); font-size:0.8rem; text-align:center; margin-top:10px; padding: 5px; background: rgba(163, 51, 255, 0.1); border-radius: 4px;">
                üëá Click anywhere on the map
            </div>
        </div>

        <div id="list" class="hide-on-collapse">
            <div style="text-align:center; color:#666; padding:20px;">Loading...</div>
        </div>
    </div>

    <div id="map"></div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal">
        <h3>Report New Event</h3>
        <div class="form-group">
            <label>Location</label>
            <input type="text" id="inpCoords" readonly style="color:#777; background: #222; cursor: not-allowed;">
        </div>
        <div class="form-group">
            <label>Magnitude (0 - 10)</label>
            <input type="number" id="inpMag" value="5.0" step="0.1" min="0" max="10" oninput="validateMag(this)">
            <div id="magError" class="error-msg">‚ö†Ô∏è Range must be 0 - 10</div>
        </div>
        <div class="form-group">
            <label>Place Name</label>
            <input type="text" id="inpPlace" placeholder="e.g. Near Tokyo">
        </div>
        <div class="form-group">
            <label class="label-danger">üíÄ Casualties</label>
            <input type="number" id="inpCasualties" value="0" min="0" style="border-color:var(--danger)">
        </div>
        <div style="display:flex; gap:10px; margin-top: 20px;">
            <button id="btnSubmit" class="btn btn-add" onclick="submitEvent()">Submit</button>
            <button class="btn" onclick="closeModal()" style="background:#444">Cancel</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // STATE
    const S = {
        lat: 50.45, lon: 30.52, 
        minMag: 2.5,
        quakes: [],
        adding: false,
        playing: false,
        tempLatLng: null
    };

    // MAP SETUP
    const map = L.map('map', { zoomControl: false }).setView([S.lat, S.lon], 3);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
    
    const layer = L.layerGroup().addTo(map);
    let userMarker = null;

    // GEOLOCATION
    navigator.geolocation.getCurrentPosition(pos => {
        S.lat = pos.coords.latitude;
        S.lon = pos.coords.longitude;
        if(userMarker) map.removeLayer(userMarker);
        const icon = L.divIcon({ className: 'custom', html: '<div class="user-pin"></div>', iconSize:[16,16] });
        userMarker = L.marker([S.lat, S.lon], {icon}).addTo(map).bindPopup("You");
        map.flyTo([S.lat, S.lon], 5);
        updateData();
    }, () => updateData());

    // --- CORE LOGIC ---

    function validateMag(input) {
        const val = parseFloat(input.value);
        const err = document.getElementById('magError');
        const btn = document.getElementById('btnSubmit');
        if (val < 0 || val > 10 || isNaN(val)) {
            input.style.borderColor = 'var(--danger)'; input.style.color = 'var(--danger)';
            err.style.display = 'block'; btn.disabled = true;
        } else {
            input.style.borderColor = '#444'; input.style.color = 'white';
            err.style.display = 'none'; btn.disabled = false;
        }
    }

    map.on('click', e => {
        if(S.adding) {
            S.tempLatLng = e.latlng;
            document.getElementById('inpCoords').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            const magInput = document.getElementById('inpMag');
            magInput.value = "5.0"; validateMag(magInput); 
            document.getElementById('addModal').style.display = 'flex';
            S.adding = false;
            document.getElementById('map').style.cursor = '';
            document.getElementById('addHint').style.display = 'none';
        }
    });

    async function updateData() {
        if(S.playing) return;
        try {
            const res = await fetch(`/api/quakes?lat=${S.lat}&lon=${S.lon}&minMag=${S.minMag}`);
            const data = await res.json();
            S.quakes = data.sort((a,b) => (b.isUserReported ? 1 : 0) - (a.isUserReported ? 1 : 0) || b.mag - a.mag);
            render(S.quakes);
        } catch(e) { console.error(e); }
    }

    // üî• –§–£–ù–ö–¶–Ü–Ø –í–ò–î–ê–õ–ï–ù–ù–Ø üî•
    async function deleteEvent(id, event) {
        // –ó—É–ø–∏–Ω—è—î–º–æ —Å–ø–ª–∏–≤–∞–Ω–Ω—è –ø–æ–¥—ñ—ó, —â–æ–± –∫–∞—Ä—Ç–∞ –Ω–µ –ª–µ—Ç—ñ–ª–∞ –¥–æ –º–∞—Ä–∫–µ—Ä–∞ –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ "–≤–∏–¥–∞–ª–∏—Ç–∏"
        if(event) event.stopPropagation();
        
        if(!confirm("Are you sure you want to delete this event?")) return;

        try {
            await fetch(`/api/quakes/${id}`, { method: 'DELETE' });
            updateData(); // –û–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫
        } catch(e) {
            alert("Error deleting event");
        }
    }

    function render(list) {
        const elList = document.getElementById('list');
        elList.innerHTML = '';
        layer.clearLayers();

        if(list.length === 0) { elList.innerHTML = '<div style="padding:20px; text-align:center">No events found.</div>'; return; }

        list.forEach(q => {
            const isUser = q.isUserReported;
            const color = isUser ? '#a333ff' : getCol(q.mag);
            const radius = Math.pow(q.mag, 2)/1.8 + 3;

            // –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è (–¢–Ü–õ–¨–ö–ò –î–õ–Ø –Æ–ó–ï–†–Ü–í)
            const deleteBtn = isUser 
                ? `<div style="text-align:right; margin-top:5px;">
                    <button class="btn-delete" onclick="deleteEvent('${q.usgsId}', event)">üóëÔ∏è Delete</button>
                   </div>` 
                : '';
            
            // –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –≤ –ø–æ–ø–∞–ø—ñ
            const popupDelete = isUser
                ? `<hr style="border-color:#444"><button class="btn-delete" style="width:100%" onclick="deleteEvent('${q.usgsId}')">üóëÔ∏è Delete Event</button>`
                : '';

            // LIST ITEM
            const item = document.createElement('div');
            item.className = 'quake-item';
            item.style.borderLeftColor = color;
            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <b style="color:${color}; font-size:1.1em">M ${parseFloat(q.mag).toFixed(1)} ${isUser?'üë§':''}</b>
                    <small style="color:#888">${new Date(q.time).toLocaleTimeString()}</small>
                </div>
                <div style="font-size:0.9em; margin:4px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${q.place}</div>
                <div style="font-size:0.8em; color:#aaa">
                    Depth: ${q.depth}km ${q.casualties > 0 ? `| <b style="color:var(--danger)">üíÄ ${q.casualties}</b>` : ''}
                </div>
                ${deleteBtn}
            `;
            item.onclick = () => map.flyTo([q.coordinates[1], q.coordinates[0]], 8);
            elList.appendChild(item);

            // MAP CIRCLE
            L.circleMarker([q.coordinates[1], q.coordinates[0]], {
                color: color, fillColor: color, fillOpacity: 0.5, radius: radius, weight: 1
            }).bindPopup(`
                <div style="text-align:center">
                    <b style="color:${color}; font-size:1.2em">M ${parseFloat(q.mag).toFixed(1)}</b><br>${q.place}<br>
                    ${q.casualties > 0 ? `<b style="color:red">üíÄ ${q.casualties} Victims</b><br>` : ''}
                    <small>${new Date(q.time).toLocaleString()}</small>
                    ${popupDelete}
                </div>
            `).addTo(layer);
        });
    }

    async function playHistory() {
        if(S.playing) return;
        S.playing = true;
        const btn = document.getElementById('btnPlay');
        btn.innerHTML = "‚èπ Playing..."; btn.classList.add('playing');
        
        layer.clearLayers();
        const sorted = [...S.quakes].sort((a,b) => a.time - b.time);
        
        for(let q of sorted) {
            const color = q.isUserReported ? '#a333ff' : getCol(q.mag);
            L.circleMarker([q.coordinates[1], q.coordinates[0]], {
                color: color, fillColor: color, fillOpacity: 0.6, radius: Math.pow(q.mag, 2)/1.8 + 3, weight: 1
            }).addTo(layer);
            await new Promise(r => setTimeout(r, 100));
        }
        
        S.playing = false; btn.innerHTML = "‚ñ∂ Play 24h History"; btn.classList.remove('playing');
        render(S.quakes); 
    }

    function enableAddMode() {
        S.adding = true; document.getElementById('map').style.cursor = 'crosshair';
        document.getElementById('addHint').style.display = 'block';
    }

    async function submitEvent() {
        const magVal = parseFloat(document.getElementById('inpMag').value);
        if (magVal < 0 || magVal > 10 || isNaN(magVal)) { alert("‚ùå Invalid Magnitude!"); return; }

        const payload = {
            lat: S.tempLatLng.lat, lng: S.tempLatLng.lng, mag: magVal,
            place: document.getElementById('inpPlace').value || "Unknown Location",
            casualties: document.getElementById('inpCasualties').value, depth: 10
        };
        await fetch('/api/quakes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        closeModal(); updateData();
    }

    function flyHighRisk() {
        const max = S.quakes.reduce((prev, curr) => (prev.mag > curr.mag) ? prev : curr, S.quakes[0]);
        if(max) map.flyTo([max.coordinates[1], max.coordinates[0]], 6);
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    function closeModal() { document.getElementById('addModal').style.display = 'none'; }
    function getCol(m) { return m>=7?'#ff0055' : m>=6?'#ff4400' : m>=5?'#ff9900' : '#00c851'; }

    document.getElementById('magInput').addEventListener('change', e => {
        S.minMag = e.target.value; document.getElementById('magVal').innerText = S.minMag; updateData();
    });

</script>
</body>
</html>