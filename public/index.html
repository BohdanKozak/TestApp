<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –ê–Ω–∞–ª—ñ–∑—É –°–µ–π—Å–º—ñ—á–Ω–∏—Ö –†–∏–∑–∏–∫—ñ–≤</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --bg: #1a1a1a; --panel: #242424; --text: #e0e0e0;
            --accent: #4a90e2; --danger: #ff4444; --warning: #ffbb33; --success: #00c851;
            --user-event: #a333ff; --loc-select: #00d2ff;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        #app { display: flex; height: 100%; }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { 
            width: 380px; background: var(--panel); display: flex; flex-direction: column; 
            border-right: 1px solid #333; z-index: 1000; transition: width 0.3s ease; overflow-x: hidden; white-space: nowrap;
        }
        #sidebar.collapsed { width: 60px; }
        #sidebar.collapsed .hide-on-collapse { display: none; opacity: 0; }
        #sidebar.collapsed .header { justify-content: center; }
        #sidebar.collapsed .menu-toggle { margin: 0; }

        .header { padding: 18px; background: #1f1f1f; border-bottom: 1px solid #333; display: flex; align-items: center; }
        .menu-toggle { cursor: pointer; font-size: 1.4rem; margin-right: 15px; color: var(--accent); min-width: 24px; text-align: center; }
        .app-title { font-weight: 700; letter-spacing: 0.5px; color: #fff; }

        .controls { padding: 15px; background: #2a2a2a; border-bottom: 1px solid #333; }
        
        /* –°–õ–ê–ô–î–ï–† */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0 15px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #111; border-radius: 4px; border: 1px solid #444; }
        input[type=range]::-webkit-slider-thumb { height: 16px; width: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: 0 0 5px rgba(0,0,0,0.5); border: 2px solid #fff; }

        /* –ö–ù–û–ü–ö–ò */
        .btn { 
            width: 100%; padding: 11px; border: none; color: white; cursor: pointer; border-radius: 6px; 
            font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; font-size: 0.9rem;
        }
        .btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-refresh { background: var(--accent); }
        .btn-add { background: var(--user-event); }
        .btn-loc { background: transparent; border: 1px solid var(--loc-select); color: var(--loc-select); }
        .btn-loc:hover { background: var(--loc-select); color: #000; }
        .btn-risk { background: rgba(255, 68, 68, 0.15); border: 1px solid var(--danger); color: var(--danger); }
        .btn-risk:hover { background: var(--danger); color: white; }
        .btn-analyze { background: linear-gradient(135deg, #00c6ff, #0072ff); box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3); }
        .btn-play { background: #333; border: 1px solid #555; }
        .btn-play.playing { background: var(--success); color: black; border-color: var(--success); }

        .btn-delete {
            background: transparent; border: 1px solid #555; color: #888; 
            padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 5px;
        }
        .btn-delete:hover { background: var(--danger); color: white; border-color: var(--danger); }

        #list { flex: 1; overflow-y: auto; padding: 10px; }
        .quake-item { background: #2f2f2f; padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border-left: 4px solid transparent; transition: background 0.2s; }
        .quake-item:hover { background: #3a3a3a; }

        /* –ö–ê–†–¢–ê */
        #map { flex: 1; background: #0b0b0b; }
        .user-pin { width: 16px; height: 16px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 0 2px white, 0 0 15px var(--accent); animation: pulse 2s infinite; }
        .target-pin { width: 16px; height: 16px; background: var(--loc-select); border-radius: 50%; box-shadow: 0 0 0 2px white, 0 0 15px var(--loc-select); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2.5); } }

        /* –ü–Ü–î–ö–ê–ó–ö–ò */
        .action-hint { display:none; font-size:0.8rem; text-align:center; margin-top:10px; padding: 8px; border-radius: 6px; border: 1px dashed; }
        .hint-add { color:var(--user-event); background: rgba(163, 51, 255, 0.1); border-color: var(--user-event); }
        .hint-loc { color:var(--loc-select); background: rgba(0, 210, 255, 0.1); border-color: var(--loc-select); }

        /* –ú–û–î–ê–õ–¨–ù–Ü –í–Ü–ö–ù–ê */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: #242424; padding: 25px; border-radius: 12px; width: 340px; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal h3 { margin-top: 0; color: #fff; margin-bottom: 20px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 6px; }
        .form-group input { width: 100%; padding: 10px; background: #151515; border: 1px solid #444; color: white; border-radius: 5px; box-sizing: border-box; outline: none; transition: 0.2s; }
        .form-group input:focus { border-color: var(--accent); }
        .error-msg { color: var(--danger); font-size: 0.8rem; display: none; margin-top: 5px; }

        /* –ê–ù–ê–õ–Ü–¢–ò–ß–ù–ò–ô –î–ê–®–ë–û–†–î */
        .analysis-modal { width: 600px; max-width: 90vw; max-height: 90vh; overflow-y: auto; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #1a1a1a; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        .stat-val { font-size: 1.4rem; font-weight: bold; margin: 5px 0; }
        .stat-label { font-size: 0.8rem; color: #888; }
        
        .risk-gauge { height: 12px; background: #333; border-radius: 6px; overflow: hidden; margin: 20px 0; position: relative; }
        .risk-fill { height: 100%; width: 0%; transition: width 1s ease-out; }
        .risk-labels { display: flex; justify-content: space-between; font-size: 0.75rem; color: #666; margin-top: -15px; margin-bottom: 15px;}
        
        .chart-bar-container { display: flex; align-items: flex-end; height: 120px; gap: 8px; padding-top: 20px; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .chart-col { flex: 1; background: var(--accent); opacity: 0.7; transition: height 0.5s; border-radius: 4px 4px 0 0; position: relative; }
        .chart-col:hover { opacity: 1; }
        
        .rec-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #555; }
        .rec-title { font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .rec-text { font-size: 0.85rem; color: #ccc; line-height: 1.4; }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div class="header">
            <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>
            <div class="app-title hide-on-collapse">–°–µ–π—Å–º—ñ—á–Ω–∏–π –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</div>
        </div>
        
        <div class="controls hide-on-collapse">
            <label style="font-size:0.8rem; color:#aaa; margin-bottom: 5px; display:block;">–ú—ñ–Ω. –ú–∞–≥–Ω—ñ—Ç—É–¥–∞: <b id="magVal" style="color:var(--accent)">2.5</b></label>
            <input type="range" id="magInput" min="0" max="8" step="0.1" value="2.5">

            <button class="btn btn-analyze" onclick="showAnalysis()">üìä –ó–≤—ñ—Ç –ê–Ω–∞–ª—ñ–∑—É –†–∏–∑–∏–∫—ñ–≤</button>
            <button class="btn btn-loc" onclick="enableLocMode()">üìç –ó–º—ñ–Ω–∏—Ç–∏ –¢–æ—á–∫—É –ê–Ω–∞–ª—ñ–∑—É</button>
            <button class="btn btn-refresh" onclick="updateData()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –î–∞–Ω—ñ</button>
            <button class="btn btn-add" onclick="enableAddMode()">‚ûï –î–æ–¥–∞—Ç–∏ –ü–æ–¥—ñ—é</button>
            <button class="btn btn-risk" onclick="flyHighRisk()">‚ö†Ô∏è –ó–Ω–∞–π—Ç–∏ –ù–∞–π–≤–∏—â–∏–π –†–∏–∑–∏–∫</button>
            <button id="btnPlay" class="btn btn-play" onclick="playHistory()">‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –Ü—Å—Ç–æ—Ä—ñ—é (24–≥–æ–¥)</button>
            
            <div id="addHint" class="action-hint hint-add">
                üëá –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –î–û–î–ê–¢–ò –ü–û–î–Ü–Æ
            </div>
            <div id="locHint" class="action-hint hint-loc">
                üëá –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –û–ë–†–ê–¢–ò –¢–û–ß–ö–£ –ê–ù–ê–õ–Ü–ó–£
            </div>
        </div>

        <div id="list" class="hide-on-collapse">
            <div style="text-align:center; color:#666; padding:30px;">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏...</div>
        </div>
    </div>

    <div id="map"></div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal">
        <h3 style="color:var(--user-event)">–ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø–æ–¥—ñ—é</h3>
        <div class="form-group">
            <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏</label>
            <input type="text" id="inpCoords" readonly style="color:#777; background: #1a1a1a; cursor: not-allowed;">
        </div>
        <div class="form-group">
            <label>–ú–∞–≥–Ω—ñ—Ç—É–¥–∞ (0 - 10)</label>
            <input type="number" id="inpMag" value="5.0" step="0.1" min="0" max="10" oninput="validateMag(this)">
            <div id="magError" class="error-msg">‚ö†Ô∏è –î–æ–ø—É—Å—Ç–∏–º–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω: 0 - 10</div>
        </div>
        <div class="form-group">
            <label>–ú—ñ—Å—Ü–µ (–Ω–∞–∑–≤–∞)</label>
            <input type="text" id="inpPlace" placeholder="–Ω–∞–ø—Ä. –ü–æ–±–ª–∏–∑—É –û–¥–µ—Å–∏">
        </div>
        <div class="form-group">
            <label style="color:var(--danger); font-weight:bold;">üíÄ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—Å—Ç—Ä–∞–∂–¥–∞–ª–∏—Ö</label>
            <input type="number" id="inpCasualties" value="0" min="0" style="border-color:var(--danger)">
        </div>
        <div style="display:flex; gap:10px; margin-top: 25px;">
            <button id="btnSubmit" class="btn btn-add" onclick="submitEvent()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
            <button class="btn" onclick="closeModal('addModal')" style="background:#333">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
</div>

<div id="analysisModal" class="modal-overlay">
    <div class="modal analysis-modal">
        <h3 style="color:var(--accent); border-color:var(--accent)">–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –ó–≤—ñ—Ç</h3>
        
        <div id="riskStatus" style="padding:15px; border-radius:8px; margin-bottom:20px; text-align:center; font-weight:bold; font-size:1.1rem; border:1px solid transparent;">
            –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫...
        </div>

        <div style="margin-bottom: 25px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                <span>–õ–æ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –Ω–µ–±–µ–∑–ø–µ–∫–∏</span>
                <span id="scoreVal">0/100</span>
            </div>
            <div class="risk-gauge">
                <div id="riskFill" class="risk-fill"></div>
            </div>
            <div class="risk-labels">
                <span>–ë–µ–∑–ø–µ—á–Ω–æ</span><span>–ü–æ–º—ñ—Ä–Ω–æ</span><span>–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-label">–ù–∞–π–±–ª–∏–∂—á–∞ –∑–∞–≥—Ä–æ–∑–∞</div>
                <div id="statDist" class="stat-val" style="font-size:1.2rem; color:var(--accent)">-</div>
                <div class="stat-label">–∫—ñ–ª–æ–º–µ—Ç—Ä—ñ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å</div>
                <div id="statMMI" class="stat-val" style="color:var(--warning)">-</div>
                <div class="stat-label">–®–∫–∞–ª–∞ –ú–µ—Ä–∫–∞–ª–ª—ñ (MMI)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í–∏–≤—ñ–ª—å–Ω–µ–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è (24–≥)</div>
                <div id="statEnergy" class="stat-val" style="font-size:1.1rem; color:#e0e0e0">-</div>
                <div class="stat-label">–¢—Ä–æ—Ç–∏–ª–æ–≤–∏–π –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–¢—Ä–µ–Ω–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>
                <div id="statTrend" class="stat-val">-</div>
                <div class="stat-label">–ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ –º–∏–Ω—É–ª–∏–º –ø–µ—Ä—ñ–æ–¥–æ–º</div>
            </div>
        </div>

        <div id="recBlock" class="rec-box">
            <div class="rec-title">üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏:</div>
            <div id="recText" class="rec-text">–ê–Ω–∞–ª—ñ–∑ –¥–∞–Ω–∏—Ö –Ω–µ –≤–∏—è–≤–∏–≤ –∑–Ω–∞—á–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑.</div>
        </div>

        <div style="margin-top:25px;">
            <div style="font-size:0.85rem; color:#aaa; margin-bottom:10px;">–†–æ–∑–ø–æ–¥—ñ–ª –º–∞–≥–Ω—ñ—Ç—É–¥ (–æ—Å—Ç–∞–Ω–Ω—è –¥–æ–±–∞)</div>
            <div id="chartContainer" class="chart-bar-container"></div>
            <div style="display:flex; justify-content:space-around; font-size:0.7rem; color:#666;">
                <span>–ú—ñ–∫—Ä–æ</span><span>–°–ª–∞–±–∫—ñ</span><span>–ü–æ–º—ñ—Ä–Ω—ñ</span><span>–°–∏–ª—å–Ω—ñ</span><span>–í–µ–π–ª.</span>
            </div>
        </div>

        <button class="btn" onclick="closeModal('analysisModal')" style="background:#333; margin-top:20px;">–ó–∞–∫—Ä–∏—Ç–∏ –∑–≤—ñ—Ç</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // APP STATE
    const S = {
        lat: 50.45, lon: 30.52, // Default (Kyiv)
        minMag: 2.5,
        quakes: [],
        adding: false,
        selectingLoc: false,
        playing: false,
        tempLatLng: null
    };

    // MAP INIT
    const map = L.map('map', { zoomControl: false }).setView([S.lat, S.lon], 3);
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
    
    const layer = L.layerGroup().addTo(map);
    let userMarker = null;

    // GEOLOCATION (Initial only)
    navigator.geolocation.getCurrentPosition(pos => {
        S.lat = pos.coords.latitude;
        S.lon = pos.coords.longitude;
        updateUserPin(false); 
        map.flyTo([S.lat, S.lon], 5);
        updateData();
    }, () => {
        updateUserPin(false);
        updateData();
    });

    function updateUserPin(isManual) {
        if(userMarker) map.removeLayer(userMarker);
        
        const cssClass = isManual ? 'target-pin' : 'user-pin';
        const text = isManual ? '<b>–¢–æ—á–∫–∞ –ê–Ω–∞–ª—ñ–∑—É</b><br>–û–±—Ä–∞–Ω–æ –≤—Ä—É—á–Ω—É' : '<b>–í–∞—à–∞ –õ–æ–∫–∞—Ü—ñ—è</b><br>GPS';
        
        const icon = L.divIcon({ className: 'custom', html: `<div class="${cssClass}"></div>`, iconSize:[16,16] });
        userMarker = L.marker([S.lat, S.lon], {icon}).addTo(map).bindPopup(text);
        
        if(isManual) userMarker.openPopup();
    }

    // --- CORE LOGIC ---

    async function updateData() {
        if(S.playing) return;
        try {
            const res = await fetch(`/api/quakes?lat=${S.lat}&lon=${S.lon}&minMag=${S.minMag}`);
            const data = await res.json();
            S.quakes = data.sort((a,b) => (b.isUserReported ? 1 : 0) - (a.isUserReported ? 1 : 0) || b.mag - a.mag);
            render(S.quakes);
        } catch(e) { console.error(e); }
    }

    function render(list) {
        const elList = document.getElementById('list');
        elList.innerHTML = '';
        layer.clearLayers();

        if(list.length === 0) { elList.innerHTML = '<div style="padding:20px; text-align:center; color:#555">–ù–µ–º–∞—î –ø–æ–¥—ñ–π —É —Ä–∞–¥—ñ—É—Å—ñ.</div>'; return; }

        list.forEach(q => {
            const isUser = q.isUserReported;
            const color = isUser ? '#a333ff' : getCol(q.mag);
            const radius = Math.pow(q.mag, 2)/1.8 + 3;

            const delBtnList = isUser ? `<div style="text-align:right"><button class="btn-delete" onclick="del('${q.usgsId}', event)">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button></div>` : '';
            const delBtnPopup = isUser ? `<hr style="border-color:#444"><button class="btn-delete" style="width:100%" onclick="del('${q.usgsId}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–¥—ñ—é</button>` : '';

            const dist = calcDist(S.lat, S.lon, q.coordinates[1], q.coordinates[0]);

            const item = document.createElement('div');
            item.className = 'quake-item';
            item.style.borderLeftColor = color;
            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <b style="color:${color}; font-size:1.1em">M ${parseFloat(q.mag).toFixed(1)} ${isUser?'üë§':''}</b>
                    <small style="color:#888">${new Date(q.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small>
                </div>
                <div style="font-size:0.9em; margin:4px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#ccc">${q.place}</div>
                <div style="display:flex; justify-content:space-between; font-size:0.8em; color:#888">
                    <span>–ì–ª–∏–±: ${q.depth}–∫–º</span>
                    <span>–í—ñ–¥—Å—Ç: ${dist}–∫–º</span>
                </div>
                ${q.casualties > 0 ? `<div style="font-size:0.8em; color:var(--danger); text-align:right">üíÄ –ü–æ—Å—Ç—Ä–∞–∂–¥–∞–ª–∏—Ö: ${q.casualties}</div>` : ''}
                ${delBtnList}
            `;
            item.onclick = () => map.flyTo([q.coordinates[1], q.coordinates[0]], 8);
            elList.appendChild(item);

            L.circleMarker([q.coordinates[1], q.coordinates[0]], {
                color: color, fillColor: color, fillOpacity: 0.5, radius: radius, weight: 1
            }).bindPopup(`
                <div style="text-align:center">
                    <b style="color:${color}; font-size:1.3em">M ${parseFloat(q.mag).toFixed(1)}</b><br>
                    <span style="font-size:0.9em">${q.place}</span><br>
                    ${q.casualties > 0 ? `<b style="color:var(--danger)">üíÄ –ü–æ—Å—Ç—Ä–∞–∂–¥–∞–ª–∏—Ö: ${q.casualties}</b><br>` : ''}
                    <small style="color:#aaa">${new Date(q.time).toLocaleString()}</small>
                    <div style="margin-top:5px; font-size:0.9em">–í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ —Ç–æ—á–∫–∏: <b>${dist}–∫–º</b></div>
                    ${delBtnPopup}
                </div>
            `).addTo(layer);
        });
    }

    // --- ANALYTICS MODULE (UKRAINIAN + SCIENCE) ---

    function showAnalysis() {
        if(S.quakes.length === 0) { alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É."); return; }
        document.getElementById('analysisModal').style.display = 'flex';

        let totalRiskScore = 0;
        let nearestDist = 99999;
        let maxMMI = 0;
        let totalEnergyJoules = 0;
        
        const buckets = [0, 0, 0, 0, 0]; 

        S.quakes.forEach(q => {
            const dist = calcDist(S.lat, S.lon, q.coordinates[1], q.coordinates[0]);
            if(dist < nearestDist) nearestDist = dist;

            // MMI Estimate
            let intensity = (1.5 * q.mag) - (2 * Math.log10(dist + 10)) + 1.5;
            if(intensity < 0) intensity = 0;
            if(intensity > maxMMI) maxMMI = intensity;

            // Energy Calculation (Gutenberg-Richter): log E = 4.8 + 1.5M (Joules)
            const energy = Math.pow(10, 4.8 + 1.5 * q.mag);
            totalEnergyJoules += energy;

            // Risk
            if(dist < 2000) totalRiskScore += (Math.pow(10, q.mag/2) / (dist + 50)) * 100;

            if(q.mag < 4) buckets[0]++;
            else if(q.mag < 5) buckets[1]++;
            else if(q.mag < 6) buckets[2]++;
            else if(q.mag < 7) buckets[3]++;
            else buckets[4]++;
        });

        totalRiskScore = Math.min(Math.round(totalRiskScore), 100);
        
        // --- RENDER UI ---

        // 1. Status
        const rStatus = document.getElementById('riskStatus');
        const rFill = document.getElementById('riskFill');
        const recBox = document.getElementById('recBlock');
        const recText = document.getElementById('recText');

        document.getElementById('scoreVal').innerText = `${totalRiskScore}/100`;
        rFill.style.width = `${totalRiskScore}%`;

        if(totalRiskScore < 20) {
            rStatus.innerHTML = "‚úÖ –ù–ò–ó–¨–ö–ò–ô –†–Ü–í–ï–ù–¨ –ó–ê–ì–†–û–ó–ò";
            rStatus.style.cssText = "background:rgba(0,200,81,0.2); color:var(--success); border-color:var(--success); padding:15px; border-radius:8px; text-align:center; font-weight:bold; border: 1px solid;";
            rFill.style.background = "var(--success)";
            recBox.style.borderLeftColor = "var(--success)";
            recText.innerHTML = "–°–µ–π—Å–º—ñ—á–Ω–∞ –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ø–æ–∫—ñ–π–Ω–∞. –ó–∞–≥—Ä–æ–∑ –¥–ª—è —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ. –ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ —Ä–æ–±–æ—Ç—É –≤ —à—Ç–∞—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ.";
        } else if (totalRiskScore < 60) {
            rStatus.innerHTML = "‚ö†Ô∏è –ü–û–ú–Ü–†–ù–ò–ô –†–Ü–í–ï–ù–¨";
            rStatus.style.cssText = "background:rgba(255,187,51,0.2); color:var(--warning); border-color:var(--warning); padding:15px; border-radius:8px; text-align:center; font-weight:bold; border: 1px solid;";
            rFill.style.background = "var(--warning)";
            recBox.style.borderLeftColor = "var(--warning)";
            recText.innerHTML = "–ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ —Å–µ–π—Å–º—ñ—á–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å. –ú–æ–∂–ª–∏–≤—ñ —Å–ª–∞–±–∫—ñ –ø–æ—à—Ç–æ–≤—Ö–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–∞–Ω–∞–ª–∏ –∑–≤'—è–∑–∫—É —Ç–∞ —Å—Ç–∞–Ω –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö –≤–∏—Ö–æ–¥—ñ–≤.";
        } else {
            rStatus.innerHTML = "‚õî –ö–†–ò–¢–ò–ß–ù–ê –ù–ï–ë–ï–ó–ü–ï–ö–ê";
            rStatus.style.cssText = "background:rgba(255,68,68,0.2); color:var(--danger); border-color:var(--danger); padding:15px; border-radius:8px; text-align:center; font-weight:bold; border: 1px solid;";
            rFill.style.background = "var(--danger)";
            recBox.style.borderLeftColor = "var(--danger)";
            recText.innerHTML = "–£–í–ê–ì–ê! –í–∏—Å–æ–∫–∞ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Ä—É–π–Ω—ñ–≤–Ω–∏—Ö –ø–æ—à—Ç–æ–≤—Ö—ñ–≤. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ —Ç—Ä–∏–≤–æ–∂–Ω—É –≤–∞–ª—ñ–∑—É, –ø–µ—Ä–µ–∫—Ä–∏–π—Ç–µ –≥–∞–∑/–≤–æ–¥—É —Ç–∞ –∑–∞–π–º—ñ—Ç—å –±–µ–∑–ø–µ—á–Ω–µ –º—ñ—Å—Ü–µ.";
        }

        // 2. Stats
        document.getElementById('statDist').innerText = nearestDist === 99999 ? ">2000" : nearestDist;
        
        // Roman Numerals
        const roman = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
        document.getElementById('statMMI').innerText = roman[Math.min(Math.max(Math.round(maxMMI), 1), 10) - 1] || "I";

        // Energy to TNT (1 ton TNT = 4.184 * 10^9 J)
        const tonsTNT = totalEnergyJoules / (4.184 * 1000000000);
        let energyStr = "";
        if(tonsTNT < 1) energyStr = `${(tonsTNT * 1000).toFixed(1)} –∫–≥`;
        else if(tonsTNT < 1000) energyStr = `${tonsTNT.toFixed(1)} —Ç`;
        else if(tonsTNT < 1000000) energyStr = `${(tonsTNT/1000).toFixed(1)} –∫—Ç`; // Kilotons
        else energyStr = `${(tonsTNT/1000000).toFixed(2)} –ú—Ç`; // Megatons
        document.getElementById('statEnergy').innerText = energyStr;

        // Trend (Mockup logic based on list position)
        const recentCount = S.quakes.slice(0, S.quakes.length/2).length;
        document.getElementById('statTrend').innerHTML = `<span style="color:${recentCount > S.quakes.length/2 ? 'var(--warning)' : 'var(--success)'}">${recentCount > S.quakes.length/2 ? '‚Üó –ó—Ä–æ—Å—Ç–∞–Ω–Ω—è' : '‚Üò –°–ø–∞–¥'}</span>`;

        // 3. Chart
        const chart = document.getElementById('chartContainer');
        chart.innerHTML = '';
        const maxVal = Math.max(...buckets, 1);
        buckets.forEach(val => {
            const h = (val / maxVal) * 100;
            const bar = document.createElement('div');
            bar.className = 'chart-col';
            bar.style.height = `${h}%`;
            bar.title = `${val} –ø–æ–¥—ñ–π`;
            chart.appendChild(bar);
        });
    }

    // --- ACTIONS ---

    async function del(id, e) {
        if(e) e.stopPropagation();
        if(!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–æ–¥—ñ—é?")) return;
        await fetch(`/api/quakes/${id}`, { method:'DELETE' });
        updateData();
    }

    function validateMag(input) {
        const val = parseFloat(input.value);
        const err = document.getElementById('magError');
        const btn = document.getElementById('btnSubmit');
        if (val < 0 || val > 10 || isNaN(val)) {
            input.style.borderColor = 'var(--danger)'; err.style.display = 'block'; btn.disabled = true;
        } else {
            input.style.borderColor = '#444'; err.style.display = 'none'; btn.disabled = false;
        }
    }

    async function submitEvent() {
        const payload = {
            lat: S.tempLatLng.lat, lng: S.tempLatLng.lng,
            mag: parseFloat(document.getElementById('inpMag').value),
            place: document.getElementById('inpPlace').value || "–ù–µ–≤—ñ–¥–æ–º–∞ –ª–æ–∫–∞—Ü—ñ—è",
            casualties: document.getElementById('inpCasualties').value, depth: 10
        };
        await fetch('/api/quakes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        closeModal('addModal'); updateData();
    }

    // --- MAP INTERACTIONS ---

    function enableLocMode() {
        S.selectingLoc = true; S.adding = false;
        document.getElementById('map').style.cursor = 'crosshair';
        toggleHints('loc');
    }

    function enableAddMode() {
        S.adding = true; S.selectingLoc = false;
        document.getElementById('map').style.cursor = 'crosshair';
        toggleHints('add');
    }

    map.on('click', e => {
        if(S.selectingLoc) {
            S.lat = e.latlng.lat; S.lon = e.latlng.lng;
            updateUserPin(true); updateData(); resetMapState();
        }
        else if(S.adding) {
            S.tempLatLng = e.latlng;
            document.getElementById('inpCoords').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            validateMag(document.getElementById('inpMag')); 
            document.getElementById('addModal').style.display = 'flex';
            resetMapState();
        }
    });

    function resetMapState() {
        S.adding = false; S.selectingLoc = false;
        document.getElementById('map').style.cursor = '';
        toggleHints('none');
    }

    async function playHistory() {
        if(S.playing) return;
        S.playing = true;
        const btn = document.getElementById('btnPlay');
        btn.innerHTML = "‚èπ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è..."; btn.classList.add('playing');
        layer.clearLayers();
        const sorted = [...S.quakes].sort((a,b) => a.time - b.time);
        for(let q of sorted) {
            const color = q.isUserReported ? '#a333ff' : getCol(q.mag);
            L.circleMarker([q.coordinates[1], q.coordinates[0]], {
                color: color, fillColor: color, fillOpacity: 0.6, radius: Math.pow(q.mag, 2)/1.8 + 3, weight: 1
            }).addTo(layer);
            await new Promise(r => setTimeout(r, 100));
        }
        S.playing = false; btn.innerHTML = "‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –Ü—Å—Ç–æ—Ä—ñ—é (24–≥–æ–¥)"; btn.classList.remove('playing');
        render(S.quakes);
    }

    // --- UTILS ---
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function toggleHints(mode) {
        document.getElementById('addHint').style.display = mode === 'add' ? 'block' : 'none';
        document.getElementById('locHint').style.display = mode === 'loc' ? 'block' : 'none';
    }
    function flyHighRisk() {
        const max = S.quakes.reduce((prev, curr) => (prev.mag > curr.mag) ? prev : curr, S.quakes[0]);
        if(max) map.flyTo([max.coordinates[1], max.coordinates[0]], 6);
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function getCol(m) { return m>=7?'#ff0055' : m>=6?'#ff4400' : m>=5?'#ff9900' : '#00c851'; }

    document.getElementById('magInput').addEventListener('change', e => {
        S.minMag = e.target.value; document.getElementById('magVal').innerText = S.minMag; updateData();
    });

</script>
</body>
</html>