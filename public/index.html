<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seismic Risk Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #2c2c2c;
            --text-color: #e0e0e0;
            --accent: #4a90e2;
            --danger: #ff4444;
            --success: #00c851;
        }

        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; }
        
        #app-container { display: flex; height: 100%; width: 100%; }

        /* --- SIDEBAR STYLES --- */
        #sidebar { 
            width: 350px; 
            background: var(--panel-color); 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid #444; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.5); 
            z-index: 1000;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
            white-space: nowrap; 
        }
        
        /* === COLLAPSED STATE FIX === */
        #sidebar.collapsed { width: 60px; }
        
        /* –•–æ–≤–∞—î–º–æ –≤—Å–µ –∑–∞–π–≤–µ –ø—Ä–∏ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—ñ */
        #sidebar.collapsed .sidebar-title,
        #sidebar.collapsed .controls,
        #sidebar.collapsed #list,
        #sidebar.collapsed .data-info { 
            opacity: 0; 
            pointer-events: none; 
            display: none; /* –í–∞–∂–ª–∏–≤–æ: –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –∑ –ø–æ—Ç–æ–∫—É, —â–æ–± –Ω–µ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞–ª–æ –∫–Ω–æ–ø–∫—É */
        }
        
        /* –¶–µ–Ω—Ç—Ä—É—î–º–æ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –ø—Ä–∏ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—ñ */
        #sidebar.collapsed .header { 
            padding: 15px 0; 
            justify-content: center; 
        }
        #sidebar.collapsed .menu-toggle { 
            margin: 0; 
        }

        /* HEADER */
        .header { 
            padding: 20px; 
            border-bottom: 1px solid #444; 
            background: #222; 
            display: flex; 
            align-items: center; 
            min-height: 25px; 
        }
        
        .menu-toggle {
            cursor: pointer;
            font-size: 1.5rem;
            margin-right: 15px;
            color: var(--accent);
            transition: 0.2s;
            /* –ó–∞–±–µ–∑–ø–µ—á—É—î–º–æ, —â–æ –∫–Ω–æ–ø–∫–∞ –∑–∞–≤–∂–¥–∏ –∑–≤–µ—Ä—Ö—É */
            position: relative;
            z-index: 1001;
            min-width: 25px; /* –§—ñ–∫—Å—É—î–º–æ —à–∏—Ä–∏–Ω—É, —â–æ–± –Ω–µ —Å–ø–ª—é—â—É–≤–∞–ª–æ */
            text-align: center;
        }
        .menu-toggle:hover { color: #fff; transform: scale(1.1); }
        
        .sidebar-title { font-size: 1.2rem; font-weight: bold; color: #fff; }

        /* CONTROLS */
        .controls { padding: 15px; background: #333; border-bottom: 1px solid #444; }
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; font-size: 0.8rem; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--accent); }
        
        /* BUTTONS */
        .btn {
            width: 100%; padding: 12px; border: none; color: white; cursor: pointer; border-radius: 6px; 
            font-weight: 600; margin-bottom: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-refresh { background: var(--accent); }
        .btn-refresh:hover { background: #357abd; transform: translateY(-1px); }
        
        .btn-risk { background: rgba(255, 68, 68, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .btn-risk:hover { background: var(--danger); color: white; }
        
        .btn-play { background: #333; border: 1px solid #555; color: #fff; }
        .btn-play:hover { background: #444; border-color: #777; }
        .btn-play.playing { background: var(--success); border-color: var(--success); color: #000; }

        /* LIST */
        #list { flex: 1; overflow-y: auto; padding: 10px; }
        .quake-item { background: #3a3a3a; padding: 12px; margin-bottom: 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; border-left: 5px solid transparent; }
        .quake-item:hover { background: #444; transform: translateX(3px); }
        
        .q-header { display: flex; justify-content: space-between; align-items: center; }
        .q-meta { font-size: 0.75rem; color: #aaa; margin-top: 6px; display: flex; justify-content: space-between; }
        
        .data-info { padding: 8px; text-align: center; font-size: 0.7rem; color: #666; background: #222; border-top: 1px solid #444; }

        /* MAP */
        #map { flex: 1; height: 100%; background: #0b0b0b; }
        
        /* User Marker Animation */
        @keyframes pulse-ring { 0% { transform: scale(0.33); opacity: 1; } 80%, 100% { opacity: 0; } }
        @keyframes pulse-dot { 0% { transform: scale(0.8); } 50% { transform: scale(1); } 100% { transform: scale(0.8); } }
        
        .user-marker-pin {
            width: 20px; height: 20px; border-radius: 50%; background: var(--accent); position: relative;
            box-shadow: 0 0 0 2px white; animation: pulse-dot 2s infinite;
        }
        .user-marker-pin::after {
            content: ''; width: 100%; height: 100%; border-radius: 50%; background: var(--accent); opacity: 0.6;
            position: absolute; top:0; left:0; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; transform: scale(2.5);
        }
        .loader { text-align: center; padding: 20px; color: #666; }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="sidebar">
            <div class="header">
                <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>
                <div class="sidebar-title">Seismic Risk AI</div>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label>Min Magnitude: <b id="magValue" style="color:var(--accent)">2.5</b></label>
                    <input type="range" id="magInput" min="2.5" max="8" step="0.1" value="2.5">
                </div>
                
                <button class="btn btn-refresh" onclick="updateData()">
                    <span>üîÑ</span> Refresh Data
                </button>
                
                <button id="btnHighestRisk" class="btn btn-risk" onclick="flyToHighestRisk()">
                    <span>‚ö†Ô∏è</span> Highest Risk
                </button>

                <button id="btnPlay" class="btn btn-play" onclick="playHistory()">
                    <span>‚ñ∂</span> Play 24h History
                </button>
            </div>

            <div id="list">
                <div class="loader">Initializing...</div>
            </div>

            <div class="data-info">
                Live Data: USGS (Last 24h)
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIG
        const STATE = {
            userLat: 50.45, userLon: 30.52, 
            minMag: 2.5,
            quakes: [],
            isPlaying: false
        };

        // MAP SETUP
        const map = L.map('map', { zoomControl: false }).setView([STATE.userLat, STATE.userLon], 3);
        L.control.zoom({ position: 'topright' }).addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© OpenStreetMap, ¬© CartoDB',
            maxZoom: 19
        }).addTo(map);

        let userMarker = null;
        let markersLayer = L.layerGroup().addTo(map);

        // GEOLOCATION
        function initGeoLocation() {
            if (!navigator.geolocation) { updateData(); return; }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    STATE.userLat = pos.coords.latitude;
                    STATE.userLon = pos.coords.longitude;
                    updateUserMarker();
                    updateData();
                    map.flyTo([STATE.userLat, STATE.userLon], 5, { duration: 1.5 });
                },
                (err) => { 
                    console.warn("Geo denied:", err);
                    updateUserMarker();
                    updateData(); 
                }
            );
        }

        function updateUserMarker() {
            if (userMarker) map.removeLayer(userMarker);
            const icon = L.divIcon({
                className: 'custom-user-marker',
                html: '<div class="user-marker-pin"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            userMarker = L.marker([STATE.userLat, STATE.userLon], {icon: icon})
                .addTo(map).bindPopup("Your Location");
        }

        // DATA LOGIC
        async function updateData() {
            if (STATE.isPlaying) return;
            
            const listEl = document.getElementById('list');
            const btnRisk = document.getElementById('btnHighestRisk');
            
            listEl.innerHTML = '<div class="loader">Fetching data...</div>';
            btnRisk.style.opacity = 0.5;

            try {
                const res = await fetch(`/api/quakes?lat=${STATE.userLat}&lon=${STATE.userLon}&minMag=${STATE.minMag}`);
                if(!res.ok) throw new Error("API Error");
                
                const data = await res.json();
                STATE.quakes = data.sort((a, b) => b.mag - a.mag);
                
                renderList(STATE.quakes);
                renderMap(STATE.quakes);
                
                btnRisk.style.opacity = 1;
            } catch (err) {
                listEl.innerHTML = `<div style="color:#ff5555; padding:10px; text-align:center;">Connection Error.<br>Check Server.</div>`;
            }
        }

        function renderList(quakes) {
            const listEl = document.getElementById('list');
            listEl.innerHTML = '';
            
            if(quakes.length === 0) {
                listEl.innerHTML = '<div class="loader">No events found.</div>';
                return;
            }

            quakes.forEach(q => {
                const color = getMagColor(q.mag);
                const el = document.createElement('div');
                el.className = 'quake-item';
                el.style.borderLeftColor = color;
                el.innerHTML = `
                    <div class="q-header">
                        <b style="color:${color}; font-size:1.1em">M ${q.mag.toFixed(1)}</b>
                        <span style="font-size:0.7em; color:#888">${new Date(q.time).toLocaleTimeString()}</span>
                    </div>
                    <div style="font-size:0.9em; margin:4px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${q.place}</div>
                    <div class="q-meta">
                        <span>${q.depth}km deep</span>
                        <span>${q.risk.distance.toLocaleString()}km away</span>
                    </div>
                `;
                el.onclick = () => {
                    map.flyTo([q.coordinates[1], q.coordinates[0]], 7);
                    el.style.backgroundColor = '#555';
                    setTimeout(() => el.style.backgroundColor = '', 300);
                };
                listEl.appendChild(el);
            });
        }

        function renderMap(quakes) {
            markersLayer.clearLayers();
            quakes.forEach(q => addMarkerToMap(q));
        }

        function addMarkerToMap(q) {
            const color = getMagColor(q.mag);
            const radius = Math.pow(q.mag, 2) / 1.5 + 3;

            L.circleMarker([q.coordinates[1], q.coordinates[0]], {
                radius: radius,
                fillColor: color,
                color: color,
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.4
            })
            .bindPopup(`
                <div style="text-align:center">
                    <b style="color:${color}; font-size:1.2em">M ${q.mag}</b><br>
                    ${q.place}<br>
                    <small>${new Date(q.time).toLocaleString()}</small>
                </div>
            `)
            .addTo(markersLayer);
        }

        // HISTORY PLAYBACK
        async function playHistory() {
            if (STATE.isPlaying) return;
            if (STATE.quakes.length === 0) return;

            STATE.isPlaying = true;
            const btn = document.getElementById('btnPlay');
            btn.innerHTML = "<span>‚èπ</span> Playing...";
            btn.classList.add('playing');
            
            markersLayer.clearLayers();
            const chronological = [...STATE.quakes].sort((a, b) => a.time - b.time);

            for (let i = 0; i < chronological.length; i++) {
                addMarkerToMap(chronological[i]);
                const delay = chronological.length > 50 ? 50 : 150;
                await new Promise(r => setTimeout(r, delay));
            }

            STATE.isPlaying = false;
            btn.innerHTML = "<span>‚ñ∂</span> Play 24h History";
            btn.classList.remove('playing');
        }

        function getMagColor(mag) {
            if (mag >= 7.0) return '#ff0055'; 
            if (mag >= 6.0) return '#ff4400';
            if (mag >= 5.0) return '#ff9900';
            if (mag >= 4.0) return '#ffcc00';
            return '#00c851';
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('collapsed');
            setTimeout(() => map.invalidateSize(), 300);
        }

        function flyToHighestRisk() {
            if(STATE.quakes.length > 0) {
                const bigOne = STATE.quakes[0];
                map.flyTo([bigOne.coordinates[1], bigOne.coordinates[0]], 6);
            }
        }

        document.getElementById('magInput').addEventListener('change', (e) => {
            STATE.minMag = e.target.value;
            document.getElementById('magValue').innerText = e.target.value;
            updateData();
        });

        initGeoLocation();
    </script>
</body>
</html>