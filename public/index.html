<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –ê–Ω–∞–ª—ñ–∑—É –°–µ–π—Å–º—ñ—á–Ω–∏—Ö –†–∏–∑–∏–∫—ñ–≤</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* DARK THEME RESTORED */
            --bg: #0f0f0f; 
            --panel: #1a1a1a; 
            --text: #e0e0e0;
            --text-muted: #a0a0a0;
            --border: #333;
            
            /* –ê–∫—Ü–µ–Ω—Ç–∏ */
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --success: #10b981; 
            --user-event: #a855f7; 
            --loc-select: #06b6d4;
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        #app { display: flex; height: 100%; }

        /* –°–ê–ô–î–ë–ê–† */
        #sidebar { 
            width: 380px; background: var(--panel); display: flex; flex-direction: column; 
            border-right: 1px solid var(--border); z-index: 1000; transition: width 0.3s ease; 
            overflow-x: hidden; white-space: nowrap; box-shadow: 10px 0 20px rgba(0,0,0,0.5);
        }
        #sidebar.collapsed { width: 70px; }
        #sidebar.collapsed .hide-on-collapse { display: none; opacity: 0; }
        #sidebar.collapsed .header { justify-content: center; padding: 20px 0; }
        #sidebar.collapsed .menu-toggle { margin: 0; }

        .header { 
            padding: 20px; background: #141414; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; 
        }
        .menu-toggle { 
            cursor: pointer; font-size: 1.5rem; margin-right: 15px; color: var(--text); 
            min-width: 24px; text-align: center; transition: 0.2s;
        }
        .menu-toggle:hover { color: var(--primary); }
        .app-title { font-weight: 700; font-size: 1.1rem; color: #fff; letter-spacing: 0.5px; }

        .controls { padding: 20px; background: var(--panel); border-bottom: 1px solid var(--border); }
        
        /* –°–õ–ê–ô–î–ï–† (DARK) */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0 20px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; cursor: pointer; background: #333; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { height: 18px; width: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; -webkit-appearance: none; margin-top: -6px; box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); border: 2px solid #fff; transition: transform 0.1s; }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* –ö–ù–û–ü–ö–ò */
        .btn { 
            width: 100%; padding: 12px; border: none; color: white; cursor: pointer; border-radius: 8px; 
            font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; 
            transition: all 0.2s; font-size: 0.9rem;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: none; background: #444; }
        
        .btn-analyze { background: linear-gradient(135deg, #6366f1, #4f46e5); box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4); }
        .btn-loc { background: transparent; color: var(--loc-select); border: 1px solid var(--loc-select); }
        .btn-loc:hover { background: rgba(6, 182, 212, 0.1); }
        .btn-refresh { background: #2563eb; }
        .btn-add { background: linear-gradient(135deg, #a855f7, #7c3aed); }
        .btn-risk { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-risk:hover { background: var(--danger); color: white; }
        .btn-play { background: #333; border: 1px solid #555; }
        .btn-play.playing { background: var(--success); color: black; border-color: var(--success); }

        .btn-delete {
            background: transparent; border: 1px solid #444; color: #888;
            padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; margin-top: 5px; font-weight: 600;
        }
        .btn-delete:hover { background: var(--danger); color: white; border-color: var(--danger); }

        /* –°–ü–ò–°–û–ö */
        #list { flex: 1; overflow-y: auto; padding: 15px; background: #141414; }
        .quake-item { 
            background: #222; padding: 15px; margin-bottom: 12px; border-radius: 10px; 
            cursor: pointer; border-left: 4px solid transparent; 
            transition: background 0.2s; 
        }
        .quake-item:hover { background: #2a2a2a; }

        /* –ö–ê–†–¢–ê */
        #map { flex: 1; background: #000; }
        
        /* –ú–∞—Ä–∫–µ—Ä–∏ */
        .user-pin { width: 18px; height: 18px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 0 2px white, 0 0 15px var(--primary); animation: pulse 2s infinite; }
        .target-pin { width: 18px; height: 18px; background: var(--loc-select); border-radius: 50%; box-shadow: 0 0 0 2px white, 0 0 15px var(--loc-select); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2.5); } }

        /* HINTS */
        .action-hint { display:none; font-size:0.85rem; text-align:center; margin-top:12px; padding: 10px; border-radius: 8px; font-weight: 600; }
        .hint-add { color: var(--user-event); background: rgba(168, 85, 247, 0.1); border: 1px dashed var(--user-event); }
        .hint-loc { color: var(--loc-select); background: rgba(6, 182, 212, 0.1); border: 1px dashed var(--loc-select); }

        /* –ú–û–î–ê–õ–¨–ù–Ü –í–Ü–ö–ù–ê (DARK) */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal { background: #222; padding: 30px; border-radius: 16px; width: 380px; border: 1px solid #333; box-shadow: 0 25px 50px rgba(0,0,0,0.7); }
        .modal h3 { margin-top: 0; color: #fff; margin-bottom: 25px; text-align: center; font-size: 1.4rem; }
        
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; }
        .form-group input { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; outline: none; transition: 0.2s; font-size: 1rem; }
        .form-group input:focus { border-color: var(--primary); }
        .error-msg { color: var(--danger); font-size: 0.85rem; display: none; margin-top: 6px; }

        /* DASHBOARD */
        .analysis-modal { width: 650px; max-width: 95vw; max-height: 90vh; overflow-y: auto; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .stat-card { background: #1a1a1a; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #333; }
        .stat-val { font-size: 1.6rem; font-weight: 800; margin: 8px 0; color: #fff; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .risk-gauge { height: 16px; background: #333; border-radius: 10px; overflow: hidden; margin: 25px 0; position: relative; }
        .risk-fill { height: 100%; width: 0%; transition: width 1s ease-out; border-radius: 10px; }
        .risk-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); font-weight: 600; margin-top: -15px; margin-bottom: 20px;}
        
        .chart-bar-container { display: flex; align-items: flex-end; height: 140px; gap: 10px; padding-top: 20px; border-bottom: 2px solid #333; margin-bottom: 10px; }
        .chart-col { flex: 1; background: var(--primary); opacity: 0.8; transition: height 0.5s; border-radius: 6px 6px 0 0; position: relative; }
        .chart-col:hover { opacity: 1; transform: scaleY(1.05); transform-origin: bottom; }
        
        .rec-box { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-top: 25px; border-left: 5px solid var(--primary); }
        .rec-title { font-weight: 800; margin-bottom: 8px; font-size: 1rem; color: #fff; }
        .rec-text { font-size: 0.95rem; color: #ccc; line-height: 1.6; }

        /* LEAFLET CONTROL CUSTOMIZATION */
        .leaflet-control-layers { 
            background: #222; border: 1px solid #444; color: #e0e0e0; border-radius: 8px; 
        }
        .leaflet-control-zoom a {
            background-color: #222; color: #e0e0e0; border-bottom: 1px solid #444;
        }
        .leaflet-control-zoom a:hover { background-color: #333; color: white; }
    </style>
</head>
<body>

<div id="app">
    <div id="sidebar">
        <div class="header">
            <div class="menu-toggle" onclick="toggleSidebar()">‚ò∞</div>
            <div class="app-title hide-on-collapse">–°–µ–π—Å–º—ñ—á–Ω–∏–π –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥</div>
        </div>
        
        <div class="controls hide-on-collapse">
            <label style="font-size:0.85rem; color:var(--text-muted); font-weight:600; display:block;">–ú—ñ–Ω. –ú–∞–≥–Ω—ñ—Ç—É–¥–∞: <span id="magVal" style="color:var(--primary)">2.5</span></label>
            <input type="range" id="magInput" min="0" max="8" step="0.1" value="2.5">

            <button class="btn btn-analyze" onclick="showAnalysis()">üìä –ó–≤—ñ—Ç –ê–Ω–∞–ª—ñ–∑—É –†–∏–∑–∏–∫—ñ–≤</button>
            <button class="btn btn-loc" onclick="enableLocMode()">üìç –ó–º—ñ–Ω–∏—Ç–∏ –¢–æ—á–∫—É –ê–Ω–∞–ª—ñ–∑—É</button>
            <button class="btn btn-refresh" onclick="updateData()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –î–∞–Ω—ñ</button>
            <button class="btn btn-add" onclick="enableAddMode()">‚ûï –î–æ–¥–∞—Ç–∏ –ü–æ–¥—ñ—é</button>
            <button class="btn btn-risk" onclick="flyHighRisk()">‚ö†Ô∏è –ó–Ω–∞–π—Ç–∏ –ù–∞–π–≤–∏—â–∏–π –†–∏–∑–∏–∫</button>
            <button id="btnPlay" class="btn btn-play" onclick="playHistory()">‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –Ü—Å—Ç–æ—Ä—ñ—é (24–≥–æ–¥)</button>
            
            <div id="addHint" class="action-hint hint-add">
                üëá –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –î–û–î–ê–¢–ò –ü–û–î–Ü–Æ
            </div>
            <div id="locHint" class="action-hint hint-loc">
                üëá –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –∫–∞—Ä—Ç—ñ, —â–æ–± –û–ë–†–ê–¢–ò –¢–û–ß–ö–£ –ê–ù–ê–õ–Ü–ó–£
            </div>
        </div>

        <div id="list" class="hide-on-collapse">
            <div style="text-align:center; color:var(--text-muted); padding:30px;">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏...</div>
        </div>
    </div>

    <div id="map"></div>
</div>

<div id="addModal" class="modal-overlay">
    <div class="modal">
        <h3 style="color:var(--user-event)">–ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø–æ–¥—ñ—é</h3>
        <div class="form-group">
            <label>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏</label>
            <input type="text" id="inpCoords" readonly style="color:#777; cursor: not-allowed;">
        </div>
        <div class="form-group">
            <label>–ú–∞–≥–Ω—ñ—Ç—É–¥–∞ (0 - 10)</label>
            <input type="number" id="inpMag" value="5.0" step="0.1" min="0" max="10" oninput="validateMag(this)">
            <div id="magError" class="error-msg">‚ö†Ô∏è –î–æ–ø—É—Å—Ç–∏–º–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω: 0 - 10</div>
        </div>
        <div class="form-group">
            <label>–ú—ñ—Å—Ü–µ (–Ω–∞–∑–≤–∞)</label>
            <input type="text" id="inpPlace" placeholder="–Ω–∞–ø—Ä. –ü–æ–±–ª–∏–∑—É –û–¥–µ—Å–∏">
        </div>
        <div class="form-group">
            <label style="color:var(--danger); font-weight:bold;">üíÄ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—Å—Ç—Ä–∞–∂–¥–∞–ª–∏—Ö</label>
            <input type="number" id="inpCasualties" value="0" min="0" style="border-color:var(--danger)">
        </div>
        <div style="display:flex; gap:10px; margin-top: 30px;">
            <button id="btnSubmit" class="btn btn-add" onclick="submitEvent()">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
            <button class="btn" onclick="closeModal('addModal')" style="background:#333; color:var(--text); box-shadow:none;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
</div>

<div id="analysisModal" class="modal-overlay">
    <div class="modal analysis-modal">
        <h3 style="color:var(--primary); border-bottom: 2px solid #333;">–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –ó–≤—ñ—Ç</h3>
        
        <div id="riskStatus" style="padding:20px; border-radius:12px; margin-bottom:25px; text-align:center; font-weight:800; font-size:1.2rem; border:2px solid transparent;">
            –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫...
        </div>

        <div style="margin-bottom: 30px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.95rem; font-weight:600;">
                <span>–õ–æ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –Ω–µ–±–µ–∑–ø–µ–∫–∏</span>
                <span id="scoreVal">0/100</span>
            </div>
            <div class="risk-gauge">
                <div id="riskFill" class="risk-fill"></div>
            </div>
            <div class="risk-labels">
                <span>–ë–µ–∑–ø–µ—á–Ω–æ</span><span>–ü–æ–º—ñ—Ä–Ω–æ</span><span>–ö—Ä–∏—Ç–∏—á–Ω–æ</span>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-label">–ù–∞–π–±–ª–∏–∂—á–∞ –∑–∞–≥—Ä–æ–∑–∞</div>
                <div id="statDist" class="stat-val" style="font-size:1.4rem; color:var(--primary)">-</div>
                <div class="stat-label">–∫—ñ–ª–æ–º–µ—Ç—Ä—ñ–≤</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞ —ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å</div>
                <div id="statMMI" class="stat-val" style="color:var(--warning)">-</div>
                <div class="stat-label">–®–∫–∞–ª–∞ –ú–µ—Ä–∫–∞–ª–ª—ñ (MMI)</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í–∏–≤—ñ–ª—å–Ω–µ–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è (24–≥)</div>
                <div id="statEnergy" class="stat-val" style="font-size:1.2rem;">-</div>
                <div class="stat-label">–¢—Ä–æ—Ç–∏–ª–æ–≤–∏–π –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–¢—Ä–µ–Ω–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</div>
                <div id="statTrend" class="stat-val">-</div>
                <div class="stat-label">–ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ –º–∏–Ω—É–ª–∏–º –ø–µ—Ä—ñ–æ–¥–æ–º</div>
            </div>
        </div>

        <div id="recBlock" class="rec-box">
            <div class="rec-title">üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏:</div>
            <div id="recText" class="rec-text">–ê–Ω–∞–ª—ñ–∑ –¥–∞–Ω–∏—Ö –Ω–µ –≤–∏—è–≤–∏–≤ –∑–Ω–∞—á–Ω–∏—Ö –∑–∞–≥—Ä–æ–∑.</div>
        </div>

        <div style="margin-top:30px;">
            <div style="font-size:0.9rem; color:var(--text-muted); margin-bottom:15px; font-weight:600;">–†–æ–∑–ø–æ–¥—ñ–ª –º–∞–≥–Ω—ñ—Ç—É–¥ (–æ—Å—Ç–∞–Ω–Ω—è –¥–æ–±–∞)</div>
            <div id="chartContainer" class="chart-bar-container"></div>
            <div style="display:flex; justify-content:space-around; font-size:0.75rem; color:var(--text-muted); font-weight:600;">
                <span>–ú—ñ–∫—Ä–æ</span><span>–°–ª–∞–±–∫—ñ</span><span>–ü–æ–º—ñ—Ä–Ω—ñ</span><span>–°–∏–ª—å–Ω—ñ</span><span>–í–µ–π–ª.</span>
            </div>
        </div>

        <button class="btn" onclick="closeModal('analysisModal')" style="background:#333; color:var(--text); box-shadow:none; margin-top:25px;">–ó–∞–∫—Ä–∏—Ç–∏ –∑–≤—ñ—Ç</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // APP STATE
    const S = {
        lat: 50.45, lon: 30.52, // Default (Kyiv)
        minMag: 2.5,
        quakes: [],
        adding: false,
        selectingLoc: false,
        playing: false,
        tempLatLng: null
    };

    // --- MAP LAYERS ---
    // 1. –°—É–ø—É—Ç–Ω–∏–∫ (ESRI World Imagery)
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
        maxZoom: 18
    });

    // 2. –¢–µ–º–Ω–∞ –∫–∞—Ä—Ç–∞ (CartoDB Dark Matter)
    const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap, ¬© CartoDB',
        maxZoom: 19
    });

    // 3. –°–≤—ñ—Ç–ª–∞ –∫–∞—Ä—Ç–∞ (OpenStreetMap)
    const lightMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    });

    // INIT MAP (–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –°—É–ø—É—Ç–Ω–∏–∫)
    const map = L.map('map', { 
        zoomControl: false,
        layers: [satellite] // Default Layer
    }).setView([S.lat, S.lon], 3);

    // –î–æ–¥–∞—î–º–æ –∫–æ–Ω—Ç—Ä–æ–ª –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —à–∞—Ä—ñ–≤
    const baseMaps = {
        "üåå –°—É–ø—É—Ç–Ω–∏–∫": satellite,
        "üåë –¢–µ–º–Ω–∞ —Ç–µ–º–∞": darkMap,
        "üó∫Ô∏è –°–≤—ñ—Ç–ª–∞ –∫–∞—Ä—Ç–∞": lightMap
    };
    L.control.layers(baseMaps).addTo(map);

    L.control.zoom({ position: 'topright' }).addTo(map);
    
    const layer = L.layerGroup().addTo(map);
    let userMarker = null;

    // GEOLOCATION
    navigator.geolocation.getCurrentPosition(pos => {
        S.lat = pos.coords.latitude;
        S.lon = pos.coords.longitude;
        updateUserPin(false); 
        map.flyTo([S.lat, S.lon], 5);
        updateData();
    }, () => {
        updateUserPin(false);
        updateData();
    });

    function updateUserPin(isManual) {
        if(userMarker) map.removeLayer(userMarker);
        
        const cssClass = isManual ? 'target-pin' : 'user-pin';
        const text = isManual ? '<b>–¢–æ—á–∫–∞ –ê–Ω–∞–ª—ñ–∑—É</b><br>–û–±—Ä–∞–Ω–æ –≤—Ä—É—á–Ω—É' : '<b>–í–∞—à–∞ –õ–æ–∫–∞—Ü—ñ—è</b><br>GPS';
        
        const icon = L.divIcon({ className: 'custom', html: `<div class="${cssClass}"></div>`, iconSize:[18,18] });
        userMarker = L.marker([S.lat, S.lon], {icon}).addTo(map).bindPopup(text);
        
        if(isManual) userMarker.openPopup();
    }

    // --- CORE LOGIC ---

    async function updateData() {
        if(S.playing) return;
        try {
            const res = await fetch(`/api/quakes?lat=${S.lat}&lon=${S.lon}&minMag=${S.minMag}`);
            const data = await res.json();
            S.quakes = data.sort((a,b) => (b.isUserReported ? 1 : 0) - (a.isUserReported ? 1 : 0) || b.mag - a.mag);
            render(S.quakes);
        } catch(e) { console.error(e); }
    }

    function render(list) {
        const elList = document.getElementById('list');
        elList.innerHTML = '';
        layer.clearLayers();

        if(list.length === 0) { elList.innerHTML = '<div style="padding:20px; text-align:center; color:#555">–ù–µ–º–∞—î –ø–æ–¥—ñ–π —É —Ä–∞–¥—ñ—É—Å—ñ.</div>'; return; }

        list.forEach(q => {
            const isUser = q.isUserReported;
            const color = isUser ? '#8b5cf6' : getCol(q.mag);
            const radius = Math.pow(q.mag, 2)/1.8 + 4;

            const delBtnList = isUser ? `<div style="text-align:right"><button class="btn-delete" onclick="del('${q.usgsId}', event)">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button></div>` : '';
            const delBtnPopup = isUser ? `<hr style="border-color:#333"><button class="btn-delete" style="width:100%" onclick="del('${q.usgsId}')">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ–¥—ñ—é</button>` : '';

            const dist = calcDist(S.lat, S.lon, q.coordinates[1], q.coordinates[0]);

            const item = document.createElement('div');
            item.className = 'quake-item';
            item.style.borderLeftColor = color;
            item.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <b style="color:${color}; font-size:1.1em">M ${parseFloat(q.mag).toFixed(1)} ${isUser?'üë§':''}</b>
                    <small style="color:#888">${new Date(q.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small>
                </div>
                <div style="font-size:0.95em; margin:6px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#e0e0e0; font-weight:500;">${q.place}</div>
                <div style="display:flex; justify-content:space-between; font-size:0.85em; color:#888">
                    <span>–ì–ª–∏–±: ${q.depth}–∫–º</span>
                    <span>–í—ñ–¥—Å—Ç: ${dist}–∫–º</span>
                </div>
                ${q.casualties > 0 ? `<div style="font-size:0.8em; color:var(--danger); text-align:right; font-weight:bold; margin-top:4px;">üíÄ –ü–æ—Å—Ç—Ä–∞–∂–¥–∞–ª–∏—Ö: ${q.casualties}</div>` : ''}
                ${delBtnList}
            `;
            item.onclick = () => map.flyTo([q.coordinates[1], q.coordinates[0]], 8);
            elList.appendChild(item);

            L.circleMarker([q.coordinates[1], q.coordinates[0]], {
                color: color, fillColor: color, fillOpacity: 0.6, radius: radius, weight: 2
            }).bindPopup(`
                <div style="text-align:center; font-family:'Inter', sans-serif;">
                    <b style="color:${color}; font-size:1.4em">M ${parseFloat(q.mag).toFixed(1)}</b><br>
                    <span style="font-size:1em; color:#333; font-weight:600;">${q.place}</span><br>
                    ${q.casualties > 0 ? `<b style="color:var(--danger)">üíÄ –ü–æ—Å—Ç—Ä–∞–∂–¥–∞–ª–∏—Ö: ${q.casualties}</b><br>` : ''}
                    <small style="color:#666">${new Date(q.time).toLocaleString()}</small>
                    <div style="margin-top:8px; font-size:0.9em; color:#333;">–í—ñ–¥—Å—Ç–∞–Ω—å –¥–æ —Ç–æ—á–∫–∏: <b>${dist}–∫–º</b></div>
                    ${delBtnPopup}
                </div>
            `).addTo(layer);
        });
    }

    // --- ANALYTICS MODULE ---

    function showAnalysis() {
        if(S.quakes.length === 0) { alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É."); return; }
        document.getElementById('analysisModal').style.display = 'flex';

        let totalRiskScore = 0;
        let nearestDist = 99999;
        let maxMMI = 0;
        let totalEnergyJoules = 0;
        
        const buckets = [0, 0, 0, 0, 0]; 

        S.quakes.forEach(q => {
            const dist = calcDist(S.lat, S.lon, q.coordinates[1], q.coordinates[0]);
            if(dist < nearestDist) nearestDist = dist;

            let intensity = (1.5 * q.mag) - (2 * Math.log10(dist + 10)) + 1.5;
            if(intensity < 0) intensity = 0;
            if(intensity > maxMMI) maxMMI = intensity;

            const energy = Math.pow(10, 4.8 + 1.5 * q.mag);
            totalEnergyJoules += energy;

            if(dist < 2000) totalRiskScore += (Math.pow(10, q.mag/2) / (dist + 50)) * 100;

            if(q.mag < 4) buckets[0]++;
            else if(q.mag < 5) buckets[1]++;
            else if(q.mag < 6) buckets[2]++;
            else if(q.mag < 7) buckets[3]++;
            else buckets[4]++;
        });

        totalRiskScore = Math.min(Math.round(totalRiskScore), 100);
        
        const rStatus = document.getElementById('riskStatus');
        const rFill = document.getElementById('riskFill');
        const recBox = document.getElementById('recBlock');
        const recText = document.getElementById('recText');

        document.getElementById('scoreVal').innerText = `${totalRiskScore}/100`;
        rFill.style.width = `${totalRiskScore}%`;

        if(totalRiskScore < 20) {
            rStatus.innerHTML = "‚úÖ –ù–ò–ó–¨–ö–ò–ô –†–Ü–í–ï–ù–¨ –ó–ê–ì–†–û–ó–ò";
            rStatus.style.cssText = "background:rgba(0,200,81,0.2); color:var(--success); border-color:var(--success); padding:20px; border-radius:12px; text-align:center; font-weight:800; border: 2px solid;";
            rFill.style.background = "var(--success)";
            recBox.style.background = "rgba(0,200,81,0.1)";
            recBox.style.borderLeftColor = "var(--success)";
            recText.innerHTML = "–°–µ–π—Å–º—ñ—á–Ω–∞ –æ–±—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ø–æ–∫—ñ–π–Ω–∞. –ó–∞–≥—Ä–æ–∑ –¥–ª—è —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ. –ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ —Ä–æ–±–æ—Ç—É –≤ —à—Ç–∞—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ.";
        } else if (totalRiskScore < 60) {
            rStatus.innerHTML = "‚ö†Ô∏è –ü–û–ú–Ü–†–ù–ò–ô –†–Ü–í–ï–ù–¨";
            rStatus.style.cssText = "background:rgba(255,187,51,0.2); color:var(--warning); border-color:var(--warning); padding:20px; border-radius:12px; text-align:center; font-weight:800; border: 2px solid;";
            rFill.style.background = "var(--warning)";
            recBox.style.background = "rgba(255,187,51,0.1)";
            recBox.style.borderLeftColor = "var(--warning)";
            recText.innerHTML = "–ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ —Å–µ–π—Å–º—ñ—á–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å. –ú–æ–∂–ª–∏–≤—ñ —Å–ª–∞–±–∫—ñ –ø–æ—à—Ç–æ–≤—Ö–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–∞–Ω–∞–ª–∏ –∑–≤'—è–∑–∫—É —Ç–∞ —Å—Ç–∞–Ω –∞–≤–∞—Ä—ñ–π–Ω–∏—Ö –≤–∏—Ö–æ–¥—ñ–≤.";
        } else {
            rStatus.innerHTML = "‚õî –ö–†–ò–¢–ò–ß–ù–ê –ù–ï–ë–ï–ó–ü–ï–ö–ê";
            rStatus.style.cssText = "background:rgba(255,68,68,0.2); color:var(--danger); border-color:var(--danger); padding:20px; border-radius:12px; text-align:center; font-weight:800; border: 2px solid;";
            rFill.style.background = "var(--danger)";
            recBox.style.background = "rgba(255,68,68,0.1)";
            recBox.style.borderLeftColor = "var(--danger)";
            recText.innerHTML = "–£–í–ê–ì–ê! –í–∏—Å–æ–∫–∞ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Ä—É–π–Ω—ñ–≤–Ω–∏—Ö –ø–æ—à—Ç–æ–≤—Ö—ñ–≤. –ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ —Ç—Ä–∏–≤–æ–∂–Ω—É –≤–∞–ª—ñ–∑—É, –ø–µ—Ä–µ–∫—Ä–∏–π—Ç–µ –≥–∞–∑/–≤–æ–¥—É —Ç–∞ –∑–∞–π–º—ñ—Ç—å –±–µ–∑–ø–µ—á–Ω–µ –º—ñ—Å—Ü–µ.";
        }

        document.getElementById('statDist').innerText = nearestDist === 99999 ? ">2000" : nearestDist;
        const roman = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];
        document.getElementById('statMMI').innerText = roman[Math.min(Math.max(Math.round(maxMMI), 1), 10) - 1] || "I";

        const tonsTNT = totalEnergyJoules / (4.184 * 1000000000);
        let energyStr = "";
        if(tonsTNT < 1) energyStr = `${(tonsTNT * 1000).toFixed(1)} –∫–≥`;
        else if(tonsTNT < 1000) energyStr = `${tonsTNT.toFixed(1)} —Ç`;
        else if(tonsTNT < 1000000) energyStr = `${(tonsTNT/1000).toFixed(1)} –∫—Ç`;
        else energyStr = `${(tonsTNT/1000000).toFixed(2)} –ú—Ç`;
        document.getElementById('statEnergy').innerText = energyStr;

        const recentCount = S.quakes.slice(0, S.quakes.length/2).length;
        document.getElementById('statTrend').innerHTML = `<span style="color:${recentCount > S.quakes.length/2 ? 'var(--warning)' : 'var(--success)'}">${recentCount > S.quakes.length/2 ? '‚Üó –ó—Ä–æ—Å—Ç–∞–Ω–Ω—è' : '‚Üò –°–ø–∞–¥'}</span>`;

        const chart = document.getElementById('chartContainer');
        chart.innerHTML = '';
        const maxVal = Math.max(...buckets, 1);
        buckets.forEach(val => {
            const h = (val / maxVal) * 100;
            const bar = document.createElement('div');
            bar.className = 'chart-col';
            bar.style.height = `${h}%`;
            bar.title = `${val} –ø–æ–¥—ñ–π`;
            chart.appendChild(bar);
        });
    }

    // --- ACTIONS ---

    async function del(id, e) {
        if(e) e.stopPropagation();
        if(!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –ø–æ–¥—ñ—é?")) return;
        await fetch(`/api/quakes/${id}`, { method:'DELETE' });
        updateData();
    }

    function validateMag(input) {
        const val = parseFloat(input.value);
        const err = document.getElementById('magError');
        const btn = document.getElementById('btnSubmit');
        if (val < 0 || val > 10 || isNaN(val)) {
            input.style.borderColor = 'var(--danger)'; err.style.display = 'block'; btn.disabled = true;
        } else {
            input.style.borderColor = '#444'; err.style.display = 'none'; btn.disabled = false;
        }
    }

    async function submitEvent() {
        const payload = {
            lat: S.tempLatLng.lat, lng: S.tempLatLng.lng,
            mag: parseFloat(document.getElementById('inpMag').value),
            place: document.getElementById('inpPlace').value || "–ù–µ–≤—ñ–¥–æ–º–∞ –ª–æ–∫–∞—Ü—ñ—è",
            casualties: document.getElementById('inpCasualties').value, depth: 10
        };
        await fetch('/api/quakes', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        closeModal('addModal'); updateData();
    }

    // --- MAP INTERACTIONS ---

    function enableLocMode() {
        S.selectingLoc = true; S.adding = false;
        document.getElementById('map').style.cursor = 'crosshair';
        toggleHints('loc');
    }

    function enableAddMode() {
        S.adding = true; S.selectingLoc = false;
        document.getElementById('map').style.cursor = 'crosshair';
        toggleHints('add');
    }

    map.on('click', e => {
        if(S.selectingLoc) {
            S.lat = e.latlng.lat; S.lon = e.latlng.lng;
            updateUserPin(true); updateData(); resetMapState();
        }
        else if(S.adding) {
            S.tempLatLng = e.latlng;
            document.getElementById('inpCoords').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            validateMag(document.getElementById('inpMag')); 
            document.getElementById('addModal').style.display = 'flex';
            resetMapState();
        }
    });

    function resetMapState() {
        S.adding = false; S.selectingLoc = false;
        document.getElementById('map').style.cursor = '';
        toggleHints('none');
    }

    async function playHistory() {
        if(S.playing) return;
        S.playing = true;
        const btn = document.getElementById('btnPlay');
        btn.innerHTML = "‚èπ –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è..."; btn.classList.add('playing');
        layer.clearLayers();
        const sorted = [...S.quakes].sort((a,b) => a.time - b.time);
        for(let q of sorted) {
            const color = q.isUserReported ? '#8b5cf6' : getCol(q.mag);
            L.circleMarker([q.coordinates[1], q.coordinates[0]], {
                color: color, fillColor: color, fillOpacity: 0.6, radius: Math.pow(q.mag, 2)/1.8 + 3, weight: 1
            }).addTo(layer);
            await new Promise(r => setTimeout(r, 100));
        }
        S.playing = false; btn.innerHTML = "‚ñ∂ –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –Ü—Å—Ç–æ—Ä—ñ—é (24–≥–æ–¥)"; btn.classList.remove('playing');
        render(S.quakes);
    }

    // --- UTILS ---
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function toggleHints(mode) {
        document.getElementById('addHint').style.display = mode === 'add' ? 'block' : 'none';
        document.getElementById('locHint').style.display = mode === 'loc' ? 'block' : 'none';
    }
    function flyHighRisk() {
        const max = S.quakes.reduce((prev, curr) => (prev.mag > curr.mag) ? prev : curr, S.quakes[0]);
        if(max) map.flyTo([max.coordinates[1], max.coordinates[0]], 6);
    }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function getCol(m) { return m>=7?'#ef4444' : m>=6?'#f97316' : m>=5?'#f59e0b' : '#10b981'; }

    document.getElementById('magInput').addEventListener('change', e => {
        S.minMag = e.target.value; document.getElementById('magVal').innerText = S.minMag; updateData();
    });

</script>
</body>
</html>